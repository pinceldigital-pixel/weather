<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clima PWA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #E5E7EB; /* Gris claro de fondo */
            display: flex;
            flex-direction: column; /* Apilar elementos verticalmente */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        /* Importar la fuente Inter desde Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
    </style>
</head>
<body>
    
    <!-- Contenedor para la búsqueda manual, oculto por defecto -->
    <div id="search-container" class="w-full max-w-sm mx-auto mb-4 hidden">
        <p class="text-center text-gray-600 mb-2 text-sm">La geolocalización no está disponible. Por favor, ingrese una ciudad:</p>
        <div class="flex gap-2">
            <input type="text" id="city-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Buenos Aires">
            <button id="search-button" class="px-5 py-2 bg-[#1F2937] text-white rounded-lg hover:bg-gray-900 transition-colors">Buscar</button>
        </div>
    </div>


    <div id="weather-widget" class="w-full max-w-sm mx-auto bg-[#1F2937] rounded-3xl shadow-lg overflow-hidden">
        
        <!-- SECCIÓN SUPERIOR - CLIMA ACTUAL -->
        <div class="p-6 bg-[#BCC9D4] text-gray-800 rounded-t-3xl">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-2xl font-semibold" id="location-name">Buscando...</p>
                    <p class="text-8xl font-bold tracking-tighter">
                        <span id="current-temp">...</span>°
                    </p>
                    <p class="text-lg font-medium">
                        Máx: <span id="current-high">...</span>° Mín: <span id="current-low">...</span>°
                    </p>
                </div>
                <div class="w-24 h-24" id="current-icon">
                    <!-- Icono SVG del clima actual se insertará aquí -->
                </div>
            </div>
            
            <!-- PRONÓSTICO POR HORA -->
            <div class="mt-8 flex justify-between text-center">
                <div class="flex flex-col items-center">
                    <span class="font-semibold text-sm" id="hourly-time-1">--:--</span>
                    <div class="w-10 h-10 my-1" id="hourly-icon-1"></div>
                    <span class="font-bold text-xl"><span id="hourly-temp-1">...</span>°</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="font-semibold text-sm" id="hourly-time-2">--:--</span>
                    <div class="w-10 h-10 my-1" id="hourly-icon-2"></div>
                    <span class="font-bold text-xl"><span id="hourly-temp-2">...</span>°</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="font-semibold text-sm" id="hourly-time-3">--:--</span>
                    <div class="w-10 h-10 my-1" id="hourly-icon-3"></div>
                    <span class="font-bold text-xl"><span id="hourly-temp-3">...</span>°</span>
                </div>
            </div>
        </div>

        <!-- SECCIÓN INFERIOR - DETALLES Y PRONÓSTICO SEMANAL -->
        <div class="p-6 text-gray-200">
            <!-- DETALLES ADICIONALES -->
            <div class="space-y-3 mb-6">
                <div class="flex justify-between items-center">
                    <span class="font-medium">Índice de Calidad del Aire:</span>
                    <div class="flex items-center gap-2">
                        <span class="font-bold" id="aqi-status">...</span>
                        <span class="w-4 h-4 rounded-full bg-gray-500" id="aqi-indicator"></span>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-medium">Humedad:</span>
                    <div class="flex items-center gap-2">
                        <span class="font-bold"><span id="humidity">...</span>%</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>
                    </div>
                </div>
            </div>

            <!-- PRONÓSTICO SEMANAL -->
            <div class="flex justify-between text-center text-gray-300">
                <div class="flex flex-col items-center w-1/4 bg-black/20 p-2 rounded-lg">
                    <span class="font-bold text-white">Hoy</span>
                    <div class="w-12 h-12 my-1" id="daily-icon-1"></div>
                    <div class="font-semibold text-white">
                        <span id="daily-high-1">...</span>°
                    </div>
                    <div class="text-sm text-gray-400">
                        <span id="daily-low-1">...</span>°
                    </div>
                </div>
                <div class="flex flex-col items-center w-1/4">
                    <span class="font-bold" id="daily-day-2">...</span>
                    <div class="w-12 h-12 my-1" id="daily-icon-2"></div>
                    <div class="font-semibold text-white">
                        <span id="daily-high-2">...</span>°
                    </div>
                    <div class="text-sm text-gray-400">
                        <span id="daily-low-2">...</span>°
                    </div>
                </div>
                <div class="flex flex-col items-center w-1/4">
                    <span class="font-bold" id="daily-day-3">...</span>
                    <div class="w-12 h-12 my-1" id="daily-icon-3"></div>
                    <div class="font-semibold text-white">
                        <span id="daily-high-3">...</span>°
                    </div>
                    <div class="text-sm text-gray-400">
                        <span id="daily-low-3">...</span>°
                    </div>
                </div>
                <div class="flex flex-col items-center w-1/4">
                    <span class="font-bold" id="daily-day-4">...</span>
                    <div class="w-12 h-12 my-1" id="daily-icon-4"></div>
                    <div class="font-semibold text-white">
                        <span id="daily-high-4">...</span>°
                    </div>
                    <div class="text-sm text-gray-400">
                        <span id="daily-low-4">...</span>°
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Service Worker y PWA ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
        
        // --- Iconos SVG ---
        const weatherIcons = {
            'clear-day': `<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="1.5"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`,
            'cloudy': `<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>`,
            'partly-cloudy-day': `<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M12 17.5A4.5 4.5 0 0 0 16.5 13H18a4 4 0 0 0 0-8h-1.26A6.5 6.5 0 0 0 5.5 13a4.5 4.5 0 0 0 6.5 4.5Z"/><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M20 12h2"/><path d="m17.66 17.66 1.41 1.41"/><path d="M12 22v-2"/></svg>`,
            'rain': `<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M16 13.36a5 5 0 1 0-8.48-3.36q-1.08.12-2.12.88a5 5 0 0 0-1.4 7.12"/><path d="M8 19v1"/><path d="M12 21v1"/><path d="M16 19v1"/></svg>`,
            'thunderstorm': `<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M21.74 18A5.002 5.002 0 0 0 17 13h-1.74a6.5 6.5 0 1 0-12.52 3.12"/><path d="m13 12-4 5h6l-4 5"/></svg>`,
            'snow': `<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M16 13.36a5 5 0 1 0-8.48-3.36q-1.08.12-2.12.88a5 5 0 0 0-1.4 7.12"/><path d="m2 16 2.5-2.5"/><path d="m14 18-2.5 2.5"/><path d="m20 14-2.5 2.5"/><path d="m10 12-2.5 2.5"/><path d="m18 6-2.5 2.5"/><path d="m6 8-2.5 2.5"/></svg>`,
            'mist': `<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M5.5 15.5A3.5 3.5 0 0 1 9 12h10.5a2.5 2.5 0 0 1 0 5H9a3.5 3.5 0 0 1-3.5-3.5V15.5Z"/><path d="M3 12a2.5 2.5 0 0 1 0-5h10.5a3.5 3.5 0 0 1 3.5 3.5V7"/><path d="M3 7h2"/><path d="M20 17h2"/></svg>`,
        };

        // --- Lógica de la API y Renderizado ---

        const API_KEY = '1b8667da28d347c66e6c0ae01033b6f5';

        const mapIcon = (iconCode) => {
            const mapping = {
                '01d': 'clear-day', '01n': 'clear-day',
                '02d': 'partly-cloudy-day', '02n': 'partly-cloudy-day',
                '03d': 'cloudy', '03n': 'cloudy',
                '04d': 'cloudy', '04n': 'cloudy',
                '09d': 'rain', '09n': 'rain',
                '10d': 'rain', '10n': 'rain',
                '11d': 'thunderstorm', '11n': 'thunderstorm',
                '13d': 'snow', '13n': 'snow',
                '50d': 'mist', '50n': 'mist',
            };
            return mapping[iconCode] || 'cloudy';
        };

        const mapAqi = (aqiValue) => {
            const levels = { 1: 'Bueno', 2: 'Regular', 3: 'Moderado', 4: 'Malo', 5: 'Muy Malo' };
            return levels[aqiValue] || 'Desconocido';
        };
        
        const capitalize = (s) => {
            if (typeof s !== 'string') return '';
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        const formatWeatherData = (weatherData, airData) => {
            return {
                location: weatherData.timezone.split('/')[1].replace('_', ' '),
                current: {
                    temp: Math.round(weatherData.current.temp),
                    high: Math.round(weatherData.daily[0].temp.max),
                    low: Math.round(weatherData.daily[0].temp.min),
                    icon: mapIcon(weatherData.current.weather[0].icon),
                },
                hourly: weatherData.hourly.slice(1, 4).map(hour => ({
                    time: new Date(hour.dt * 1000).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                    temp: Math.round(hour.temp),
                    icon: mapIcon(hour.weather[0].icon),
                })),
                details: {
                    aqi: mapAqi(airData.list[0].main.aqi),
                    humidity: weatherData.current.humidity,
                },
                daily: weatherData.daily.slice(0, 4).map(day => ({
                    day: capitalize(new Date(day.dt * 1000).toLocaleDateString('es-ES', { weekday: 'short' }).replace('.', '')),
                    high: Math.round(day.temp.max),
                    low: Math.round(day.temp.min),
                    icon: mapIcon(day.weather[0].icon),
                })),
            };
        };

        function renderWeatherData(data) {
            document.getElementById('location-name').innerText = data.location;
            
            // Clima actual
            document.getElementById('current-temp').innerText = data.current.temp;
            document.getElementById('current-high').innerText = data.current.high;
            document.getElementById('current-low').innerText = data.current.low;
            document.getElementById('current-icon').innerHTML = weatherIcons[data.current.icon] || '';
            document.getElementById('current-icon').querySelector('svg')?.setAttribute('fill', 'white');
            document.getElementById('current-icon').querySelector('svg')?.setAttribute('stroke', 'white');
            
            // Clima por hora
            data.hourly.forEach((hour, i) => {
                document.getElementById(`hourly-time-${i+1}`).innerText = hour.time;
                document.getElementById(`hourly-temp-${i+1}`).innerText = (hour.temp >= 0 ? '+' : '') + hour.temp;
                const iconDiv = document.getElementById(`hourly-icon-${i+1}`);
                iconDiv.innerHTML = weatherIcons[hour.icon] || '';
                iconDiv.querySelector('svg')?.setAttribute('fill', '#4B5563');
                iconDiv.querySelector('svg')?.setAttribute('stroke', '#4B5563');
            });

            // Detalles
            document.getElementById('aqi-status').innerText = data.details.aqi;
            document.getElementById('humidity').innerText = data.details.humidity;
            const aqiIndicator = document.getElementById('aqi-indicator');
            aqiIndicator.className = 'w-4 h-4 rounded-full'; // Reset classes
            const aqiColors = { 'Bueno': 'bg-green-500', 'Regular': 'bg-yellow-500', 'Moderado': 'bg-orange-500', 'Malo': 'bg-red-500', 'Muy Malo': 'bg-purple-700' };
            aqiIndicator.classList.add(aqiColors[data.details.aqi] || 'bg-gray-500');

            // Pronóstico diario
            data.daily.forEach((day, i) => {
                if (i > 0) document.getElementById(`daily-day-${i+1}`).innerText = day.day;
                document.getElementById(`daily-high-${i+1}`).innerText = (day.high >= 0 ? '+' : '') + day.high;
                document.getElementById(`daily-low-${i+1}`).innerText = (day.low >= 0 ? '+' : '') + day.low;
                document.getElementById(`daily-icon-${i+1}`).innerHTML = weatherIcons[day.icon] || '';
            });
        }
        
        // --- Lógica de carga de datos ---
        const fetchWeatherByCoords = async (lat, lon) => {
             try {
                const weatherUrl = `https://api.openweathermap.org/data/3.0/onecall?lat=${lat}&lon=${lon}&exclude=minutely,alerts&appid=${API_KEY}&units=metric&lang=es`;
                const airQualityUrl = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${API_KEY}`;
                
                const [weatherResponse, airQualityResponse] = await Promise.all([
                    fetch(weatherUrl),
                    fetch(airQualityUrl)
                ]);

                if (!weatherResponse.ok || !airQualityResponse.ok) {
                    throw new Error(`Error HTTP! estado: ${weatherResponse.status} y ${airQualityResponse.status}`);
                }

                const weatherData = await weatherResponse.json();
                const airData = await airQualityResponse.json();
                
                return { weatherData, airData };

            } catch (error) {
                console.error('Error al obtener datos del clima por coordenadas:', error);
                document.getElementById('location-name').innerText = "Error al cargar datos.";
                return null;
            }
        };

        const fetchWeatherByCity = async (city) => {
            if (!city) return;
            document.getElementById('location-name').innerText = `Buscando ${city}...`;
            try {
                const geoUrl = `https://api.openweathermap.org/geo/1.0/direct?q=${city}&limit=1&appid=${API_KEY}`;
                const geoResponse = await fetch(geoUrl);
                if (!geoResponse.ok) throw new Error('Error encontrando la ciudad.');
                
                const geoData = await geoResponse.json();
                if (geoData.length === 0) {
                    document.getElementById('location-name').innerText = `Ciudad no encontrada.`;
                    return;
                }

                const { lat, lon, name } = geoData[0];
                const weatherInfo = await fetchWeatherByCoords(lat, lon);
                
                if (weatherInfo) {
                    const formattedData = formatWeatherData(weatherInfo.weatherData, weatherInfo.airData);
                    formattedData.location = name; // Usar el nombre de la ciudad buscada
                    renderWeatherData(formattedData);
                }
            } catch (error) {
                console.error('Error al buscar clima por ciudad:', error);
                document.getElementById('location-name').innerText = "Error en la búsqueda.";
            }
        };

        window.onload = () => {
            const searchContainer = document.getElementById('search-container');

            const getLocation = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const { latitude: lat, longitude: lon } = position.coords;
                            const weatherInfo = await fetchWeatherByCoords(lat, lon);
                            if (weatherInfo) {
                                const formattedData = formatWeatherData(weatherInfo.weatherData, weatherInfo.airData);
                                renderWeatherData(formattedData);
                            }
                        }, 
                        (error) => {
                            let errorMessage = "Error de ubicación.";
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage = "Permiso de ubicación denegado.";
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage = "Ubicación no disponible.";
                                    break;
                                case error.TIMEOUT:
                                    errorMessage = "Tiempo de espera agotado.";
                                    break;
                            }
                            console.error("Error de Geolocalización:", error.message);
                            document.getElementById('location-name').innerText = errorMessage;
                            searchContainer.classList.remove('hidden');
                        }
                    );
                } else {
                    document.getElementById('location-name').innerText = "Geolocalización no soportada.";
                    searchContainer.classList.remove('hidden');
                }
            };

            const searchButton = document.getElementById('search-button');
            const cityInput = document.getElementById('city-input');

            searchButton.addEventListener('click', () => fetchWeatherByCity(cityInput.value.trim()));
            cityInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    fetchWeatherByCity(cityInput.value.trim());
                }
            });

            getLocation();
        };
    </script>
</body>
</html>
